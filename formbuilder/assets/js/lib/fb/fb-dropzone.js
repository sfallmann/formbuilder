(function(){

    $("body").bind("DOMSubtreeModified", function() {
        $(this).find(".dz-remove").addClass('btn btn-danger');
    });

    //  Add the clickable and preview divs for the dropzone
    $(".buttonHolder").
        after("<div id='clickable'></div>").
            after("<hr/><div class='dz-preview' id='dz-preview-div'></div>");

    Dropzone.options.fbForm = {
        init: function(){

            var self = this;
            // URl of the form action
            var $formAction = fb.$form.attr("action");

            //  Counter for files added
            var fileCount = 0;
            //  The message if the regex check fails for filenames
            var fileValidationMessage = "Please rename {f} and try again.<br>";
            fileValidationMessage += "Only digits, letters, -, _, (, ), spaces and a ";
            fileValidationMessage += "single period before the file extension are allowed. <br><br>{f} has been removed.";

            /*  Move the dz-default div generated by dropzone into the clickable div created above
                the dz-default div generated by dropzone contains all the correct html and classes
                to take advantage of all the styling provided by dropzone.
                No need to remake it. */

            var fileSizeExceededMessage = "The file {f} exceeded the filesize limit of " + this.options.maxFilesize + "MB.";

            $(".dz-default.dz-message").detach().appendTo("#clickable");



            this.processForm = function(){

                fb.$submit.attr("disabled","true");

                if (self.getQueuedFiles().length > 0) {

                    if (self.files.length > self.options.maxFiles){
                        fb.spinner.stop();
                        fb.$popup.close();
                        fb.displayError("Too many files added to dropzone.  Only " + self.options.maxFiles + " can be added.");
                        fb.$submit.removeAttr("disabled");
                        grecaptcha.reset();
                    }
                    else {
                        self.processQueue();
                    }

                }
                else {

                    fb.$submit.attr("disabled","true");

                    setTimeout(function(){ fb.$submit.removeAttr("disabled")}, 1000);

                    $.ajax({

                        url: $formAction,
                        method: "POST",
                        data: fb.$form.serialize(),
                        success: function(response){

                            fb.spinner.stop();
                            fb.$popup.close();

                            console.log("success");
                            if (response.status == 200){

                                //fb.$submit.removeAttr("disabled");
                                window.location = response.redirect;
                            }
                            else {

                                // TODO - real error logging
                                console.log("error");
                            }

                        },
                        error: function(xhr){

                            fb.spinner.stop();
                            fb.$popup.close();
                            fb.displayError("There was a problem sending the form data to the server");

                        }
                    });
                }

            };

            // -------- Event Handling ---------

            fb.$form.on({
                "recaptcha:success": function(event){
                    console.log("recaptcha:success triggered");

                    self.processForm();
                },
                "recaptcha:fail": function(event, response){
                    console.log("recaptcha:fail triggered");

                    fb.spinner.stop();
                    fb.$popup.close();
                    fb.$submit.attr("disabled","true");

                    setTimeout(function(){ fb.$submit.removeAttr("disabled")}, 500);

                    var errors = response["error-codes"];
                    if (errors){
                        for (var i=0; i< errors.length; i++){

                            console.log(errors[i]);
                            if (errors[i] === "missing-input-response"){

                                errors[i] = "The reCaptcha box is not checked!";
                            }
                            var message = "reCaptcha Error: " + errors[i];

                            fb.displayError(message);
                        }
                    }
                    else {
                        fb.displayError("There was a problem processing your request.");
                    }

                }
            });

            //  addedFile event functionality
            this.on("addedfile", function(file){
                fileCount++;
                if (!file.name.match(/^[\()_\-\s\d\w]+([\.]?[_\-\s\d\w]+)?$/)) {
                    fb.displayError(fileValidationMessage.replaceAll("{f}", file.name));
                    self.removeFile(file);
                }
                console.log(file);
                if (file.size > (self.options.maxFilesize * 1000000)){
                    fb.displayError(fileSizeExceededMessage.replaceAll("{f}", file.name));
                    self.removeFile(file);
                }
                console.log(file)


            });
            //  removedFile event functionality
            this.on("removedFile", function(file){
                fileCount--;
            });

            this.on("error", function(file, response, xhrObject){

                fb.$submit.removeAttr("disabled");
                console.log(file, response, xhrObject);

            });

            this.on("success", function(file, response, xhrObject){

                console.log("Dropzone success..")
                console.log(file, response);

            });

            this.on("successmultiple", function(file, response, xhrObject){

                fb.$submit.removeAttr("disabled");

                console.log("Dropzone successmultiple..")
                console.log(file, response);

                var complete = function(){

                    fb.$submit.removeAttr("disabled");
                    window.location = response.redirect;
                }

                setTimeout(complete, 1750);


            });


        },
        autoProcessQueue: false,
        previewsContainer: "#dz-preview-div",
        addRemoveLinks: true,
        clickable: "#clickable",
        dictDefaultMessage: '<img class="img-responsive" src="/static/img/dzimage.png">',
        uploadMultiple: true,
        parallelUploads: 10,
        maxFiles: fb.maxFiles(),
        maxFilesize: (500/fb.maxFiles()),
        dictResponseError: "There was an error processing your request",
        dictCancelUpload: ""
    }

})();

{% extends "base_form.html" %}
{% block header_css_scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/min/dropzone.min.css">
<script src='https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/min/dropzone.min.js'></script>
<style>

    #clickable:hover {
        cursor: pointer;
    }


</style>
{% endblock %}

{% block container %}
    <div class="row">
        <div class="col-md-12">
            {{ header }}
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            {% load crispy_forms_tags %}
            {% crispy form form.helper %}
        </div>
    </div>
    <div class="row">
        <div id="error-div" class="col-md-12"></div>
    </div>
    <div class="row">
        <div class="col-md-12">
            {{ footer }}
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>

    function getCookie(name)
    {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?

                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    //  Add the clickable and preview divs for the dropzone
    $(".buttonHolder").
        after("<div id='clickable'></div>").
            after("<hr/><div class='col-sm-12 dz-preview' id='dz-preview-div'></div>");

    Dropzone.options.fbForm = {
        init: function(){

            var self = this;
            // The submit button
            var $submit = $("#submit-id-submit");
            // The form
            var $form = $("#fb-form");
            // URl of the form action
            var $formAction = $form.attr("action");
            //  Counter for files added
            var fileCount = 0;
            //  The message if the regex check fails for filenames
            var fileValidationMessage = "Filenames can only contain alphanumeric characters, spaces, underscores, dashes, ";
            fileValidationMessage += " and a period before the file extension! The file has been removed.  Please rename the file.";

            var $errorDiv = $("#error-div");

            /*  Move the dz-default div generated by dropzone into the clickable div created above
                the dz-default div generated by dropzone contains all the correct html and classes
                to take advantage of all the styling provided by dropzone.
                No need to remake it. */
            $(".dz-default.dz-message").detach().appendTo("#clickable");


            //  Stop the form from submitting when the button is clicked
            $submit.click(function(e){

                $errorDiv.html("");
                e.stopPropagation();
                e.preventDefault();

                self.recaptchaCheck();

            });


            this.processForm = function(){

                if (self.getQueuedFiles().length > 0) {
                    self.processQueue();
                }
                else {
                    $.ajax({

                        url: $formAction,
                        method: "POST",
                        data: $form.serialize(),
                        success: function(xhr){
                            console.log(xhr);

                        },
                        error: function(xhr){
                            $errorDiv.html("There was a problem sending the form data to the server");
                        }
                    });
                }

            };

            this.recaptchaCheck = function(){

                console.log("initiate reCaptcha check");

                $.ajax(
                    {
                        url: "/ajax/recaptcha_check/",
                        method: "POST",
                        data: { "g-recaptcha-response": $("#g-recaptcha-response").val() },
                        beforeSend: function(xhr, settings) {
                            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                            }
                        },
                        success: function(xhr){

                            var obj = JSON.parse(xhr);

                            if (obj.success){
                                $form.trigger("recaptcha:success");
                            }
                            else {

                                $form.trigger("recaptcha:fail", obj);
                            }
                        },
                        error: function(xhr){
                            $errorDiv.html("There was a problem sending the recaptcha check to the server");
                        }
                    });
            };

            // -------- Event Handling ---------

            $form.on({
                "recaptcha:success": function(event){
                    console.log("recaptcha:success triggered");
                    console.log(event);
                    self.processForm();
                },
                "recaptcha:fail": function(event, obj){
                    console.log("recaptcha:fail triggered");
                    var errors = obj["error-codes"];
                    for (var i=0; i< errors.length; i++){
                        console.log(errors[i]);
                        $errorDiv.html("<h4 class='alert alert-danger'>reCaptcha Error: {e}</h4>".replace("{e}",errors[i]));
                    }

                    self.processForm();
                }
            });

            //  addedFile event functionality
            this.on("addedfile", function(file){
                fileCount++;
                if (!file.name.match(/^[_-\s\d\w\.]*$/)) {
                    alert(fileValidationMessage);
                    self.removeFile(file);
                }
                fileCount++;
                console.log(file)


            });
            //  removedFile event functionality
            this.on("removedFile", function(file){
                fileCount--;
            });

            this.on("error", function(file, response, xhrObject){

                console.log(file, response, xhrObject);

            });

            this.on("success", function(file, response, xhrObject){

                console.log(file, response);

            });


        },
        autoProcessQueue: false,
        previewsContainer: "#dz-preview-div",
        addRemoveLinks: true,
        clickable: "#clickable",
        dictDefaultMessage: '<img class="img-responsive" src="/static/img/dzimage.png">',
        uploadMultiple: true,
        parallelUploads: 10,
        maxFiles: 10,
        dictResponseError: "There was an error processing your request"
    }






</script>


{% endblock %}

{% extends "base_form.html" %}
{% block header_css_scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/min/dropzone.min.css">
<script src='https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/min/dropzone.min.js'></script>
<style>



    #clickable:hover {
        cursor: pointer;
    }

    .dz-filename {
        font-weight: bold;
        margin-top: 45px;
    }

    .dz-error-message {
        margin-top: 20px;
    }

    .dz-remove {
        margin-top: 5px;
        font-weight: bold;
    }

    a.dz-remove.btn.btn-danger:hover {
        text-decoration: none;
    }

    #dz-preview-div {
        margin: 0px;
        padding: 0px;
    }

</style>
{% endblock %}

{% block scripts %}
<script>

(function(){

    $("body").bind("DOMSubtreeModified", function() {
        $(this).find(".dz-remove").addClass('btn btn-danger');
    });

    function getCookie(name)
    {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?

                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    //  Add the clickable and preview divs for the dropzone
    $(".buttonHolder").
        after("<div id='clickable'></div>").
            after("<hr/><div class='dz-preview' id='dz-preview-div'></div>");

    Dropzone.options.fbForm = {
        init: function(){

            var self = this;
            // The submit button
            var $submit = $("#submit-id-submit");
            // The form
            var $form = $("#fb-form");
            // URl of the form action
            var $formAction = $form.attr("action");
            //  Counter for files added
            var fileCount = 0;
            //  The message if the regex check fails for filenames
            var fileValidationMessage = "Filenames can only contain alphanumeric characters, spaces, underscores, dashes, ";
            fileValidationMessage += " and a period before the file extension! The file has been removed.  Please rename the file.";

            var $errorDiv = $("#error-div");

            /*  Move the dz-default div generated by dropzone into the clickable div created above
                the dz-default div generated by dropzone contains all the correct html and classes
                to take advantage of all the styling provided by dropzone.
                No need to remake it. */
            $(".dz-default.dz-message").detach().appendTo("#clickable");


            //  Stop the form from submitting when the button is clicked
            $submit.click(function(e){

                clearErrors();

                e.stopPropagation();
                e.preventDefault();

                self.recaptchaCheck();

            });

            this.processForm = function(){

                if (self.getQueuedFiles().length > 0) {

                    $submit.attr("disabled", "true");
                    self.processQueue();
                }
                else {

                    $submit.attr("disabled");

                    $.ajax({

                        url: $formAction,
                        method: "POST",
                        data: $form.serialize(),
                        success: function(response){

                            if (repsonse.status == 200){

                                $submit.removeAttr("disabled");
                                window.location = response.redirect;
                            }
                            else {

                                $submit.removeAttr("disabled");
                                // TODO - real error logging
                                console.log("error");
                            }

                        },
                        error: function(xhr){
                            $errorDiv.html("There was a problem sending the form data to the server");
                        }
                    });
                }

            };

            this.recaptchaCheck = function(){

                console.log("initiate reCaptcha check");

                $.ajax(
                    {
                        url: "/ajax/recaptcha_check/",
                        method: "POST",
                        data: { "g-recaptcha-response": $("#g-recaptcha-response").val() },
                        beforeSend: function(xhr, settings) {
                            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                            }
                        },
                        success: function(response){

                            if (response.success){
                                $form.trigger("recaptcha:success");
                            }
                            else {

                                $form.trigger("recaptcha:fail", response);
                            }
                        },
                        error: function(xhr){
                            var messsage = "There was a problem sending the recaptcha check to the server"
                            displayError(message);
                        }
                    });
            };

            // -------- Event Handling ---------

            $form.on({
                "recaptcha:success": function(event){
                    console.log("recaptcha:success triggered");
                    console.log(event);
                    self.processForm();
                },
                "recaptcha:fail": function(event, response){
                    console.log("recaptcha:fail triggered");

                    var errors = response["error-codes"];

                    for (var i=0; i< errors.length; i++){

                        console.log(errors[i]);
                        var message = "reCaptcha Error: " + errors[i];

                        displayError(message);
                    }

                }
            });

            //  addedFile event functionality
            this.on("addedfile", function(file){
                fileCount++;
                if (!file.name.match(/^[_-\s\d\w\.]*$/)) {
                    displayError(fileValidationMessage);
                    self.removeFile(file);
                }
                fileCount++;
                console.log(file)


            });
            //  removedFile event functionality
            this.on("removedFile", function(file){
                fileCount--;
            });

            this.on("error", function(file, response, xhrObject){

                $submit.removeAttr("disabled");
                console.log(file, response, xhrObject);

            });

            this.on("success", function(file, response, xhrObject){

                console.log("Dropzone success..")
                console.log(file, response);

            });

            this.on("successmultiple", function(file, response, xhrObject){



                console.log("Dropzone successmultiple..")
                console.log(file, response);

                var complete = function(){

                    //$submit.removeAttr("disabled");
                    window.location = response.redirect;
                }

                setTimeout(complete, 1750);


            });


        },
        autoProcessQueue: false,
        previewsContainer: "#dz-preview-div",
        addRemoveLinks: true,
        clickable: "#clickable",
        dictDefaultMessage: '<img class="img-responsive" src="/static/img/dzimage.png">',
        uploadMultiple: true,
        parallelUploads: 10,
        maxFiles: 10,
        maxFilesize: 50,
        dictResponseError: "There was an error processing your request",
        dictCancelUpload: ""
    }

    })();
</script>


{% endblock %}
